import concurrent.futures
from pymongo import MongoClient
import subprocess


def run_sqlmap(url):
    try:
        # Run SQLMap as a subprocess
        process = subprocess.Popen(['sqlmap', '-u', url, '--batch'], stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        output, error = process.communicate()

        # Check the output for indications of SQL injection vulnerabilities
        if "sql injection" in output.decode().lower():
            print(f"SQL Injection vulnerability found at {url}")

        else:
            print(f"No SQL Injection vulnerability found at {url}")
    except Exception as e:
        print(f"Error scanning {url} for SQL injection: {e}")


def main():
    try:
        # Connect to MongoDB
        client = MongoClient('mongodb://localhost:27017/')
        db = client['urls_database']
        collection = db['urls']

        # Retrieve URLs from MongoDB in batches
        batch_size = 10  # Adjust batch size as needed
        total_urls = collection.count_documents({})  # Get total number of URLs
        for skip in range(0, total_urls, batch_size):
            urls = collection.find({}, {'_id': 0, 'url': 1}).skip(skip).limit(batch_size)

            # Execute scans in parallel
            with concurrent.futures.ThreadPoolExecutor() as executor:
                executor.map(run_sqlmap, (url['url'] for url in urls))
    except Exception as e:
        print(f"Error: {e}")


if __name__ == "__main__":
    main()
